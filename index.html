<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- CSS -->
	<link href="css/jquery.mobile-1.4.2.min.css" rel="stylesheet">

	<!-- jQuery -->
	<script src="js/jquery/jquery-2.1.0.js"></script>
	<script src="js/jquery/jquery.mobile-1.4.2.min.js"></script>

	<!-- ROSLIBJS -->
	<!-- EventEmitter2 is the sole dependency of roslibjs -->
	<script src="js/ros/eventemitter2/eventemitter2.js"></script>
	<!-- Roslibjs handles core ROS functionality in the browser -->
	<script src="js/ros/roslibjs/roslib.js"></script>
	<!-- ROS2DJS -->
	<!-- EaselJS is a dependency of ros2djs -->
	<script src="js/ros/easeljs/easeljs.js"></script>
	<!-- Ros2djs provides 2D scene support, including mapping and more -->
	<script src="js/ros/ros2djs/ros2d.js"></script>

	<!-- ROS3DJS -->
	<!-- Three.js is the WebGL rendering library -->
	<script src="js/ros/three/three.js"></script>
	<!-- ColladaLoader2 loads collada models of the robot -->
	<script src="js/ros/STLLoader/STLLoader.min.js"></script>
	<!-- Ros3djs provides 3D scene support, including mapping and more -->
	<script src="js/ros/ros3djs/ros3d.js"></script>

	<script src="js/console/rosconsole.js"></script>
	<script src="js/console/rosmap.js"></script>
	<!-- NAV2D -->
	<script src="js/ros/nav2djs/nav2d.js"></script>

	<script>
		$(document).ready(function() {
			
			var name_page = "ROS Web console";
			var connection = "ubuntu.local";

			var ros = new ROSCONSOLE.controller({
				addr: connection,
				fixed_frame: '/map'
			});

			var windowController = new ROSCONSOLE.WindowController(name_page);

			var heightHeader = $(this).find('[data-role="header"]').height();
			var widthPage = $(window).width() - 16 * 2;
			var heightPage = $(window).height() - heightHeader - 16 * 2 - 10;

            /*
			// Create the scene manager and view port for the 3D world.
			var viewer3D = new ROS3D.Viewer({
				divID: 'threed-map',
				width: widthPage,
				height: heightPage,
				antialias: true
					//background: '#EEEEEE'
			});
			var map3D = new ROSCONSOLE.ROS3Dmap({
				ros: ros.ros,
				tfClient: ros.tfClient,
				viewer: viewer3D,
				width: widthPage,
				height: heightPage,
				path: connection
			});
            */
            
			var viewer = new ROS2D.Viewer({
				divID: 'nav',
				width: heightPage,
				height: heightPage,
				background: '#99FFCC'
			});
			
			
			// Setup the nav client.
			var nav = new NAV2D.OccupancyGridClientNav({
				ros: ros.ros,
				tfClient: ros.tfClient,
				continuous: true,
				robot_pose: '/base_link',
				rootObject: viewer.scene,
				withOrientation: true,
				viewer: viewer
					//serverName: '/pr2_move_base'
			});
			
			
			//viewer.scaleToDimensions(1800,1800);
			console.log("A");
			//viewer.scaleToDimensions(viewer.width/4, viewer.height/4);
			//viewer.shift(-100,-100);
			
			var map_editor = new ROSMAP.Editor({
				ros: ros.ros,
				client: nav.client,
				rootObject: viewer.scene,
			});
			
			//map_editor.resize(1000,1000);
			
			//nav.enableGoal(false);

			window.onresize = function(event) {
				var heightHeader = $(this).find('[data-role="header"]').height();
				var widthPage = $(window).width() - 16 * 2;
				var heightPage = $(window).height() - heightHeader - 16 * 2 - 110;
				viewer.resize(widthPage, heightPage);
				viewer3D.resize(widthPage, heightPage);
			};

			var button_connect = '<a href="#" id="ros-test" data-role="button" data-icon="recycle" class="ui-btn-right">Test</a>';
			$('div:jqmData(role="header")').append(button_connect).trigger('create');

			$("#ros-test").click(function(){
				console.log("click");
			});

			// ------- NEW EDITOR CONTROL
            /*
			var addTwoIntsClient = new ROSLIB.Service({
			    ros : ros.ros,
			    name : '/map_editor',
			    serviceType : 'dynamic_map/Editor'
			  });
			
			  var request = new ROSLIB.ServiceRequest({
			    type : 1,
			    thickness : 2
			  });
			
			  addTwoIntsClient.callService(request, function(result) {
			    console.log('Result for service call on ');
			     // + addTwoIntsClient.name
			     // + ': '
			     // + result.sum);
			  });

			var advpoint = new ROSLIB.Topic({
	    		ros : ros.ros,
	    		name : '/point_map',
	    		messageType : 'geometry_msgs/Vector3'
  			});

			var mouseDown = false;
			var writeEventHandler = function(event, mouseState) {

				//console.log('event: ' + mouseState + ' - mouse: ' + mouseDown);

				if (mouseState === 'down') {
					mouseDown = true;
				} else if(mouseState === 'move') {
					if(mouseDown === true) {
						var position = viewer.scene.globalToRos(event.stageX, event.stageY);
						var positionVec3 = new ROSLIB.Vector3(position);
						//TODO Console log
						//console.log('[x:' + positionVec3.x + ',y:' + positionVec3.y + ']');
						advpoint.publish(new ROSLIB.Message(positionVec3));
					}
				} else if(mouseState === 'up') {
					mouseDown = false;
				}
			};

			viewer.scene.addEventListener('stagemousedown', function(event) {
				writeEventHandler(event, 'down');
			});

			viewer.scene.addEventListener('stagemousemove', function(event) {
				writeEventHandler(event, 'move');
			});

			viewer.scene.addEventListener('stagemouseup', function(event) {
				writeEventHandler(event, 'up');
			});
			*/
		});
	</script>
	<style>
		#threed-map canvas {
			border-radius: 14px;
			box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
		}

		.map2D canvas {
			border-radius: 14px;
			box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
		}

		.border canvas {
			border-radius: 14px;
			box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(204, 204, 204, .5) 0px 1px 8px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px 0px;
		}
	</style>
</head>

<body>
	<!-- pages -->
	<!-- 3D map -->
	<div data-role="page" id="3Dmap" data-title="3D map" data-icon="navigation">
		<div data-role="content">
			<div id="threed-map"></div>
		</div>
	</div>
	<!-- 2D map -->
	<div data-role="page" id="2Dmap" data-title="2D map" data-icon="location">
		<div data-role="content">
			<div id="nav" class="map2D"></div>
		</div>
	</div>
</body>

</html>
