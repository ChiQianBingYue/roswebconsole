<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Console [Mobile]</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <!-- CSS -->
        <link href="css/jquery.mobile-1.4.2.min.css" rel="stylesheet">
        <link href="css/main.css" rel="stylesheet">
        <!-- jQuery and display.js are conveniences for interacting with the DOM -->
        <script src="js/jquery-2.1.0.js"></script>
        <script src="js/jquery.mobile-1.4.2.min.js"></script>

        <!-- FLOTCHART -->
        <script language="javascript" type="text/javascript" src="js/flot/jquery.flot.js"></script>
        <script language="javascript" type="text/javascript" src="js/flot/jquery.flot.time.js"></script>
        <!-- ROSLIBJS -->
        <!-- EventEmitter2 is the sole dependency of roslibjs -->
        <script src="js/ros/eventemitter2.js"></script>
        <!-- Roslibjs handles core ROS functionality in the browser -->
        <script src="js/ros/roslib.js"></script>

        <!-- ROS2DJS -->
        <!-- EaselJS is a dependency of ros2djs -->
        <script src="js/ros/easeljs.js"></script>
        <!-- Ros2djs provides 2D scene support, including mapping and more -->
        <script src="js/ros/ros2d.js"></script>

        <!-- ROS3DJS -->
        <!-- Three.js is the WebGL rendering library -->
        <script src="js/ros/three.js"></script>
        <!-- ColladaLoader2 loads collada models of the robot -->
        <script src="js/ros/ColladaLoader2.js"></script>
        <!-- Ros3djs provides 3D scene support, including mapping and more -->
        <script src="js/ros/ros3d.js"></script>
        <!-- ROSTELEOP -->
        <script src="js/ros/keyboardteleop.js"></script>

        <!-- Console ROS -->
        <script src="js/console.keyboard.js"></script>
        <script src="js/console.ros.js"></script>
        <script src="js/console.chart.js"></script>
        <script src="js/Vector2.js"></script>
        <script src="js/console.touch.js"></script>

        <script>
            $(document).ready(function() {

                var isiPad = navigator.userAgent.match(/iPad/i) !== null;

                var heightHeader = $(this).find('[data-role="header"]').height();
                var heightFooter = $(this).find('[data-role="footer"]').height();
                var widthPage = $(window).width() - 16 * 2;
                var halfPage = $(window).width() / 2 - 16 * 2;
                var heightPage = $(window).height() - heightHeader - heightFooter - 16 * 2 - 10;

                $(window).hashchange(function() {
                    var hash = location.hash.replace(/^#/, "");
                    console.log("change page: " + hash);
                    switch (hash) {
                        case "position":
                            $('#test').appendTo("<p>HI</p>");
                            break;
                    }
                });

                $(window).on("navigate", function(event, data) {
                    //console.log(data.state);
                });

                // -------------------------------------------------------------
                // Start ROS and MAP
                // -------------------------------------------------------------
                var ros = OpenRos();
                //$.mobile.loading("hide");       //Debug

                // -------------------------------------------------------------
                // Data Variable
                // -------------------------------------------------------------                
                var xData = new dataPlot;
                var yData = new dataPlot;
                var thData = new dataPlot;
                var vlinData = new dataPlot;
                var vMlinData = new dataPlot;
                var wData = new dataPlot;
                var wMData = new dataPlot;
                //-----
                var left_motor_rif = new dataPlot;
                var left_motor_vel = new dataPlot;
                var left_motor_con = new dataPlot;
                //-----
                var right_motor_rif = new dataPlot;
                var right_motor_vel = new dataPlot;
                var right_motor_con = new dataPlot;
                //-----
                var process = new dataPlot(7);
                process.updateArray(4, 0);
                process.updateArray(3, 0);
                process.updateArray(2, 0);
                process.updateArray(1, 0);
                process.updateArray(2, 0);
                process.updateArray(4, 0);

                // ----------------------------------------------------------------------
                // Subscribing to the robot's Pose
                // ----------------------------------------------------------------------

                // The ROSLIB.Topic handles subscribing and publishing a ROS topic. This
                // topic interacts with the /robot_pose topic, published by the robot.
                var velocityTopic = new ROSLIB.Topic({
                    ros: ros,
                    name: '/robot/velocity',
                    messageType: 'geometry_msgs/Twist'
                });
                // The ROSLIB.Topic handles subscribing and publishing a ROS topic. This
                // topic interacts with the /robot_pose topic, published by the robot.
                var poseTopic = new ROSLIB.Topic({
                    ros: ros,
                    name: '/robot/odometry',
                    messageType: 'nav_msgs/Odometry'
                });
                // Subscribes to the robot's pose. When rosbridge receives the pose
                // message from ROS, it forwards the message to roslibjs, which calls this
                // callback.
                velocityTopic.subscribe(function(message) {

                    var now = -1;//new Date().getTime();
                    vlinData.updateArray(message.linear.x, now);
                    wData.updateArray(message.angular.z, now);

                    vellin.setData([vlinData.updatePlot(), vMlinData.updatePlot()]);
                    vellin.draw();

                    wang.setData([wData.updatePlot(), wMData.updatePlot()]);
                    wang.draw();

                    $('.velocity-d').text(vlinData.getLast());
                    $('.angular-d').text(wData.getLast());
                });
                poseTopic.subscribe(function(message) {
                    // Formats the pose for outputting.
                    var now = -1;//new Date().getTime();
                    var pose = message.pose.pose.position;
                    var orien = message.pose.pose.orientation;
                    var vel = message.twist.twist;
                    var den = Math.pow(orien.w, 2) - Math.pow(orien.z, 2);
                    var num = 2 * (orien.w * orien.z);

                    xData.updateArray(pose.x, now);
                    yData.updateArray(pose.y, now);
                    thData.updateArray(Math.atan(num / den), now);

                    vMlinData.updateArray(vel.linear.x);
                    wMData.updateArray(vel.angular.z);

                    chart_position.setData([{label: "x", data: xData.updatePlot()}, {label: "y", data: yData.updatePlot()}, {label: "&theta;", data: thData.updatePlot()}]);
                    chart_position.draw();

                    $('.x-position').text(xData.getLast());
                    $('.y-position').text(yData.getLast());
                    $('.th-position').text(thData.getLast());
                    $('.velocity').text(vMlinData.getLast());
                    $('.angular').text(wMData.getLast());

                    robotMarker.x = pose.x;
                    robotMarker.y = -pose.y;
                    robotMarker.rotation = viewer2D.scene.rosQuaternionToGlobalTheta(orien);
                });

                if (isiPad) {
                    TouchDrive(ros);
                    $('#keycontrol').remove();
                    $('#threed-map').remove();
                    // ----------------------------------------------------------------------
                    // Displaying a map
                    // ----------------------------------------------------------------------

                    // The ROS2D.Viewer is a 2D scene manager with additional ROS
                    // functionality.
                    var viewer2D = new ROS2D.Viewer({
                        divID: 'twod-map',
                        width: halfPage,
                        height: heightPage,
                        background: '#ddd'
                    });

                    // Subscribes to the robot's OccupancyGrid, which is ROS representation of
                    // the map, and renders the map in the scene.
                    var gridClient = new ROS2D.OccupancyGridClient({
                        ros: ros,
                        rootObject: viewer2D.scene
                    });

                    // Subscribes to the robot's OccupancyGrid, which is ROS representation of
                    // the map, and renders the map in the scene.
                    var gridClient = new ROS2D.OccupancyGridClient({
                        ros: ros,
                        rootObject: viewer2D.scene
                    });

                    var gridMap = new ROS2D.Grid();
                    gridClient.rootObject.addChild(gridMap);

                    var robotMarker = new ROS2D.NavigationArrow({size: 12,
                        strokeSize: 1,
                        fillColor: createjs.Graphics.getRGB(255, 255, 0, 0.66),
                        pulse: false
                    });

                    gridClient.rootObject.addChild(robotMarker);
                    viewer2D.scaleToDimensions(1, 1);
                    viewer2D.shift(-0.5, -0.5);
                    robotMarker.x = 0;
                    robotMarker.y = 0;
                    robotMarker.scaleX = 0.01;
                    robotMarker.scaleY = 0.01;
                    robotMarker.rotation = 90;//- Math.PI/2;// + viewer2D.scene.rosQuaternionToGlobalTheta(0);
                    robotMarker.visible = true;
                    $('.type-system').text("iPad system");
                } else {
                    var widthBox = heightPage / 3;
                    $('.type-system').text("PC system");
                    $('#touchcontrol').remove();
                    // ----------------------------------------------------------------------
                    // Displaying a map
                    // ----------------------------------------------------------------------

                    // The ROS2D.Viewer is a 2D scene manager with additional ROS
                    // functionality.
                    var viewer2D = new ROS2D.Viewer({
                        divID: 'twod-map',
                        width: widthBox,
                        height: widthBox,
                        background: '#ddd'
                    });

                    // Subscribes to the robot's OccupancyGrid, which is ROS representation of
                    // the map, and renders the map in the scene.
                    var gridClient = new ROS2D.OccupancyGridClient({
                        ros: ros,
                        rootObject: viewer2D.scene
                    });

                    // Subscribes to the robot's OccupancyGrid, which is ROS representation of
                    // the map, and renders the map in the scene.
                    var gridClient = new ROS2D.OccupancyGridClient({
                        ros: ros,
                        rootObject: viewer2D.scene
                    });

                    var gridMap = new ROS2D.Grid();
                    gridClient.rootObject.addChild(gridMap);

                    var robotMarker = new ROS2D.NavigationArrow({size: 12,
                        strokeSize: 1,
                        fillColor: createjs.Graphics.getRGB(255, 255, 0, 0.66),
                        pulse: false
                    });

                    gridClient.rootObject.addChild(robotMarker);
                    viewer2D.scaleToDimensions(1, 1);
                    viewer2D.shift(-0.5, -0.5);
                    robotMarker.x = 0;
                    robotMarker.y = 0;
                    robotMarker.scaleX = 0.01;
                    robotMarker.scaleY = 0.01;
                    robotMarker.rotation = 90;
                    robotMarker.visible = true;
                    Open3DMap(ros, halfPage, heightPage);
                    $('#twod-map').css({position: 'absolute', top: heightHeader + heightPage + 18 - widthBox, left: 16});
                }

                // -------------------------------------------------------------
                // Control keyboard
                // -------------------------------------------------------------
                // Initialize the teleop.
                var teleop = new KEYBOARDTELEOP.Teleop({
                    ros: ros,
                    topic: '/robot/command/velocity'
                });
                teleop.scale = 0.1;

                // -------------------------------------------------------------
                // Setting height widget
                // -------------------------------------------------------------
                $(".widget-bar").height(heightPage * 2 / 7);
                // -------------------------------------------------------------
                // Setting Chart
                // -------------------------------------------------------------

                $(".chart").width(halfPage - 20);
                $(".chart").height(heightPage / 2);
                $("#motor .chart").height(heightPage / 3);
                var chart_position = $.plot("#chart-position", [{label: "x", data: xData.updatePlot()}, {label: "y", data: yData.updatePlot()}, {label: "&theta;", data: thData.updatePlot()}]);
                var vellin = $.plot("#chart-velocity-linear", [{label: "v<sub>d</sub>", data: vlinData.updatePlot()}, {label: "v", data: vMlinData.updatePlot()}]);
                var wang = $.plot("#chart-velocity-angular", [{label: "&omega;<sub>d</sub>", data: wData.updatePlot()}, {label: "&omega;", data: wMData.updatePlot()}]);

                var chart_left_motor = $.plot("#chart-motor-left",
                        [{label: "v<sub>d</sub>", data: left_motor_rif.updatePlot()},
                            {label: "v", data: left_motor_vel.updatePlot()},
                            {label: "con", data: left_motor_con.updatePlot()}
                        ]);

                var chart_right_motor = $.plot("#chart-motor-right",
                        [{label: "v<sub>d</sub>", data: right_motor_rif.updatePlot()},
                            {label: "v", data: right_motor_vel.updatePlot()},
                            {label: "con", data: right_motor_con.updatePlot()}
                        ]);

                var chart_process = $.plot("#chart-process", [{data: process.updatePlot(), bars: {barWidth: 0.6,
                            align: "center", show: true}}]);
                //$('.tickLabel').css({left: '5px'});

                // -------------------------------------------------------------
                // Control keyboard
                // -------------------------------------------------------------
                keyboard();
                $("#up-key").on('click', function(e) {
                    e.preventDefault();
                    console.log(e);
                });

                $(".slider-velocity").on("slidestop", function(event, ui) {
                    var value = event.target.value;
                    teleop.scale = value;
                });


            });
        </script>
        <style>
            .ui-loader-background {
                width:100%;
                height:100%;
                top:0;
                margin: 0;
                background: rgba(0, 0, 0, 0.3);
                display:none;
                position: fixed;
                z-index:100;
            }

            .ui-loading .ui-loader-background {
                display:block;
            }

            #twod-map {
                z-index: 0;
                top: 0px;
                left: 0px;
            }
        </style>
    </head>
    <body>
        <div class="ui-loader-background"> </div>
        <div data-role="page" id="home">
            <div data-role="header" data-position="fixed">
                <h1> Explorer Web console</h1>
                <div data-role="navbar" data-iconpos="bottom">
                    <ul>
                        <li><a href="#home" data-icon="home" data-transition="slide" class="ui-btn-active ui-state-persist">Home</a></li>
                        <li><a href="#position" data-icon="navigation" data-transition="slide">Position</a></li>
                        <li><a href="#motor" data-icon="gear" data-transition="slide">Motor</a></li>
                        <li><a href="#console" data-icon="grid" data-transition="slide">Console</a></li>
                    </ul>
                </div>
            </div>
            <div data-role="content">
                <canvas id="TouchController">HELLO!</canvas>
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <div id="threed-map"></div>
                        <div id="twod-map"></div>
                    </div>
                    <div class="ui-block-b">
                        <div class="widget-bar">
                            <h4 align="center">Position:</h4>
                            <p>x: <span class="x-position">-.-</span> [m]</p>
                            <p>y: <span class="y-position">-.-</span> [m]</p>
                            <p>&theta;: <span class="th-position">-.-</span> [rad]</p>
                        </div>
                    </div>
                    <div class="ui-block-b">
                        <div class="widget-bar">
                            <h4 align="center">Velocity:</h4>
                            <div class="ui-grid-a">
                                <div class="ui-block-a">
                                    <p>v<sub>d</sub>: <span class="velocity-d">-.-</span> [m/s]</p>
                                    <p>&omega;<sub>d</sub>: <span class="angular-d">-.-</span> [rad/s]</p>
                                </div>
                                <div class="ui-block-b">
                                    <p>v: <span class="velocity">-.-</span> [m/s]</p>
                                    <p>&omega;: <span class="angular">-.-</span> [rad/s]</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ui-block-b">
                        <div id="touchcontrol">
                            <div class="widget-bar" style="border: 1px dashed">
                                <h4 style="text-align:center">Touch control</h4>
                                <p>v<sub>touch</sub>: <span class="velocity-touch">-.-</span> [m/s]</p>
                                <p>&omega;<sub>touch</sub>: <span class="angular-touch">-.-</span> [rad/s]</p>
                            </div>
                        </div>
                        <!-- KEYCONTROL -->
                        <div id="keycontrol">
                            <div class="widget-bar" style="border: 1px dashed">
                                <div class="ui-grid-a">
                                    <div class="ui-block-a">
                                        <div data-role="controlgroup" data-type="horizontal" style="text-align:center">
                                            <a href="#" class="ui-btn ui-mini ui-corner-all">Q</a>
                                            <a href="#" class="up-key ui-btn ui-mini ui-corner-all">W</a>
                                            <a href="#" class="ui-btn ui-mini ui-corner-all">E</a>
                                        </div>
                                        <div data-role="controlgroup" data-type="horizontal" style="text-align:center">
                                            <a href="#" class="left-key ui-btn ui-mini ui-corner-all">A</a>
                                            <a href="#" class="down-key ui-btn ui-mini ui-corner-all">S</a>
                                            <a href="#" class="right-key ui-btn ui-mini ui-corner-all">D</a>
                                        </div>
                                        <a href="#" class="space-key ui-btn ui-mini ui-corner-all" style="text-align:center">SPACE</a>
                                    </div>
                                    <div class="ui-block-b">
                                        <form>
                                            <div class="ui-field-contain">
                                                <label for="slider-velocity-home">Velocity:</label>
                                                <input type="range" name="Velocity" class="slider-velocity" min="0.05" max="0.3" step="0.05" value="0.1" data-highlight="true">
                                            </div>
                                        </form>
                                        <form>
                                            <div class="ui-field-contain">
                                                <label for="slider-angular-home">Angular:</label>
                                                <input type="range" name="Angular" class="slider-angular" min="0.1" max="0.5" step="0.1" value="0.1" data-highlight="true">
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div data-role="footer" data-position="fixed">
                <a href="#" data-role="button" data-icon="recycle" class="ui-btn-left ui-state-disabled">Reconect</a>
                <p class="type-system" style="text-align:center">Status connection (mini widgets, pc version)</p>
            </div>
        </div>
        <!-- POSITION PAGE -->
        <div data-role="page" id="position">
            <div data-role="panel" data-theme="b" data-position="right" data-display="overlay" id="drive-panel" data-swipe-close="false">
                <h2 style="text-align:center">Drive Robot</h2>
                <form>
                    <label for="slider-10">Velocity:</label>
                    <input type="range" name="Velocity" class="slider-velocity" min="0.05" max="0.3" step="0.05" value="0.1" data-highlight="true">
                </form>
                <form>
                    <label for="slider-10">Angular:</label>
                    <input type="range" name="Angular" class="slider-angular" min="0.1" max="0.5" step="0.1" value="0.1" data-highlight="true">
                </form>
                <p style="text-align:center"> Key Control </p> 
                <div data-role="controlgroup" data-type="horizontal" style="text-align:center">
                    <a href="#" class="ui-btn ui-corner-all">Q</a>
                    <a href="#" class="up-key ui-btn ui-corner-all">W</a>
                    <a href="#" class="ui-btn ui-corner-all">E</a>
                </div>
                <div data-role="controlgroup" data-type="horizontal" style="text-align:center">
                    <a href="#" class="left-key ui-btn ui-corner-all">A</a>
                    <a href="#" class="down-key ui-btn ui-corner-all">S</a>
                    <a href="#" class="right-key ui-btn ui-corner-all">D</a>
                </div>
                <a href="#" class="space-key ui-btn ui-corner-all" style="text-align:center">SPACE</a>
                <hr>
                <p>Q: reset position [0,0,0]</p>
                <p>R: ------ ----- -------- </p>
            </div>
            <div data-role="header" data-position="fixed">
                <h1> Explorer Web console</h1>
                <a href="#drive-panel" data-role="button" class="ui-btn-right">Drive</a>
                <div data-role="navbar" data-iconpos="bottom">
                    <ul>
                        <li><a href="#home" data-icon="home" data-transition="slide" data-direction="reverse">Home</a></li>
                        <li><a href="#position" data-icon="navigation" data-transition="slide" class="ui-btn-active ui-state-persist">Position</a></li> <!-- location -->
                        <li><a href="#motor" data-icon="gear" data-transition="slide">Motor</a></li>
                        <li><a href="#console" data-icon="grid" data-transition="slide">Console</a></li>
                    </ul>
                </div>
            </div>
            <div data-role="content">
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <h2 class="ui-bar ui-bar-a ui-corner-all">Position</h2>
                        <div id="chart-position" class="ui-body chart"></div>
                    </div>
                    <div class="ui-block-b">
                        <div id="test">TODO</div>
                    </div>
                </div>
            </div>
            <div data-role="footer" data-position="fixed">
                <a href="#" data-role="button" data-icon="recycle" class="ui-btn-left ui-state-disabled">Reconect</a>
                <p class="type-system" style="text-align:center">Status connection (mini widgets, pc version)</p>
            </div>
        </div>
        <!-- MOTOR PAGE -->
        <div data-role="page" id="motor">
            <div data-role="header" data-position="fixed">
                <h1> Explorer Web console</h1>
                <a href="#drive-panel" data-role="button" class="ui-btn-right">Drive</a>
                <div data-role="navbar" data-iconpos="bottom">
                    <ul>
                        <li><a href="#home" data-icon="home" data-transition="slide" data-direction="reverse">Home</a></li>
                        <li><a href="#position" data-icon="navigation" data-transition="slide" data-direction="reverse">Position</a></li> <!-- location -->
                        <li><a href="#motor" data-icon="gear" data-transition="slide" class="ui-btn-active ui-state-persist">Motor</a></li>
                        <li><a href="#console" data-icon="grid" data-transition="slide">Console</a></li>
                    </ul>
                </div>
            </div>
            <div data-role="content">
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <h2 class="ui-bar ui-bar-a ui-corner-all">Linear velocity</h2>
                        <div id="chart-velocity-linear" class="ui-body chart"></div>
                    </div>
                    <div class="ui-block-b">
                        <h2 class="ui-bar ui-bar-a ui-corner-all">Angular velocity</h2>
                        <div id="chart-velocity-angular" class="ui-body chart"></div>
                    </div>
                </div>
                <div data-role="collapsible">
                    <h4>Left motor</h4>
                    <div class="ui-grid-a">
                        <div class="ui-block-a">
                            <!--<img src="images/motor.jpg" />-->
                            <div style="text-align:center;"><img alt="PID controller" src="images/PID_Loop.gif" width="350"/></div>
                        </div>
                        <div class="ui-block-b">
                            <div id="chart-motor-left" class="ui-body chart"></div>
                        </div>
                    </div>
                </div>
                <div data-role="collapsible">
                    <h4>Right motor</h4>
                    <div class="ui-grid-a">
                        <div class="ui-block-a">
                            <div style="text-align:center;"><img alt="PID controller" src="images/PID_Loop.gif" width="350"/></div>
                            <!--<img src="images/motor.jpg" />-->
                        </div>
                        <div class="ui-block-b">
                            <div id="chart-motor-right" class="ui-body chart"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div data-role="footer" data-position="fixed">
                <a href="#" data-role="button" data-icon="recycle" class="ui-btn-left ui-state-disabled">Reconect</a>
                <p class="type-system" style="text-align:center">Status connection (mini widgets, pc version)</p>
            </div>
        </div>
        <!-- CONSOLE PAGE -->
        <div data-role="page" id="console">
            <div data-role="header" data-position="fixed">
                <h1> Explorer Web console</h1>
                <a href="#drive-panel" data-role="button" class="ui-btn-right">Drive</a>
                <div data-role="navbar" data-iconpos="bottom">
                    <ul>
                        <li><a href="#home" data-icon="home" data-transition="slide" data-direction="reverse">Home</a></li>
                        <li><a href="#position" data-icon="navigation" data-transition="slide" data-direction="reverse">Position</a></li> <!-- location -->
                        <li><a href="#motor" data-icon="gear" data-transition="slide" data-direction="reverse">Motor</a></li>
                        <li><a href="#console" data-icon="grid" data-transition="slide" class="ui-btn-active ui-state-persist">Console</a></li>
                    </ul>
                </div>
            </div>
            <div data-role="content">
                <div class="ui-grid-a">
                    <div class="ui-block-a">
                        TODO
                    </div>
                    <div class="ui-block-b">
                        <h2 class="ui-bar ui-bar-a ui-corner-all">Process</h2>
                        <div id="chart-process" class="ui-body chart"></div>
                    </div>
                </div>
            </div>
            <div data-role="footer" data-position="fixed">
                <a href="#" data-role="button" data-icon="recycle" class="ui-btn-left ui-state-disabled">Reconect</a>
                <p class="type-system" style="text-align:center">Status connection (mini widgets, pc version)</p>
            </div>
        </div>
    </body>
</html>
